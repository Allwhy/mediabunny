<!DOCTYPE html>

<script src="../dist/metamuxer.js"></script>

<script type="module">
	const fileInput = document.createElement('input');
	fileInput.type = 'file';
	document.body.append(fileInput);

	const progress = document.createElement('progress');	
	progress.max = 1;
	document.body.append(progress);

	fileInput.addEventListener('change', async () => {
		const file = fileInput.files[0];

		const source = new Metamuxer.BlobSource(file);
		const target = new Metamuxer.BufferTarget() ?? new Metamuxer.StreamTarget(new WritableStream({
			write: console.log
		}), {
			chunked: true,
			chunkSize: 2**20
		});
		const outputFormat = new Metamuxer.OggOutputFormat();

		const button = document.createElement('button');
		button.textContent = 'Cancel';
		button.onclick = () => conversion.cancel();
		document.body.append(button);

		const conversion = await Metamuxer.Conversion.init({
			input: new Metamuxer.Input({
				formats: Metamuxer.ALL_FORMATS,	
				source
			}),
			output: new Metamuxer.Output({
				format: outputFormat,
				target
			}),
			audio: {
				//discard: true
				//forceReencode: true,
			},
			/*
			video: {
				discard: true,
				bitrate: Metamuxer.QUALITY_VERY_HIGH,
				//bitrate: Metamuxer.QUALITY_VERY_HIGH
				codec: 'av1',
				//width: 800,
				//fit: 'fill',
				//rotate: 90,
			},
			audio: {
				bitrate: Metamuxer.QUALITY_HIGH,
				codec: 'aac',
			},
			*/
			/*
			video: {
				codec: 'avc',
			},
			audio: {
				codec: 'mp3',
				bitrate: 320000
			},
			*/
			video: {
				//forceReencode: true,
				//rotate: 90
				//width: 720 ?? 2160,
				//height: 1280 ?? 3840,
				//fit: 'contain',
				//rotate: 90,
				//width: 512,
				//height: 512,
				//width: 200,
				//height: 100,
			},
			trim: {
				start: 0,
				end: 30
			},
			computeProgress: true
		});
		console.log(conversion);

		function updateProgress() {
			progress.value = conversion.progress;

			if (conversion.progress === 1) {
				return;
			}

			setTimeout(updateProgress, 1000/60);
		}
		updateProgress();

		console.time();
		await conversion.execute();
		console.timeEnd()

		console.log("Done", target.buffer);

		const video = document.createElement('video');
		video.src = URL.createObjectURL(new Blob([target.buffer]));	
		video.controls = true;	
		document.body.append(video);
		video.play();

		//download(new Blob([target.buffer]), 'converted' + outputFormat.fileExtension);

		function download(blob, filename) {
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = filename;
			a.click();
			URL.revokeObjectURL(url);
		}
	});
</script>